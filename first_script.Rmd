---
title: "first_script"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


# IDEAS FOR 2022
- Clutch plays
- Exepcted goals (players scoring harder goals)
- Supercoach points, and SC points in a row or during periods of close margin
- Decimal and overall probabilites - find better way to do it
- Need to weight better games where there is a standout 3 voter and no competion vs when two players have 2.5 avg votes
- See how i could have tipped wines better
- remeber i still tipped some good ones like Nank $21 and Crisp $8




```{r Load packages and source functions, message = FALSE}

# devtools::install_github("jimmyday12/fitzRoy")
library(tidyverse)
library(corrr)
library(easystats)
library(brms)
library(rstan)
library(viridis)

library(zoo)
library(parallel)
library(tidybayes)
library(tidyverse)
library(corrr)
library(janitor)
library(fitzRoy)
source("Functions/get_data_and_clean_Function.R")
source("Functions/games_played_Function.R")

```


```{r Get data, messsage = FALSE}

# Get data from 2002 to be able to calculate games_played
afl_data <- GetDataCleanFitzRoy()



# Calculate games played using GamesPlayed function
afl_data_2 <- GamesPlayed(afl_data)

# change match winner team to abb
afl_data_2 <- afl_data_2 %>%
  mutate(match_winner = case_when(match_winner == "Geelong"            ~ "GEE",
                              match_winner == "Hawthorn"               ~ "HAW",
                              match_winner == "Brisbane Lions"         ~ "BRI",
                              match_winner == "Brisbane"               ~ "BRI",
                              match_winner == "Collingwood"            ~ "COL",
                              match_winner == "North Melbourne"        ~ "NME",
                              match_winner == "Fremantle"              ~ "FRE",
                              match_winner == "Essendon"               ~ "ESS",
                              match_winner == "Carlton"                ~ "CAR",
                              match_winner == "Sydney"                 ~ "SYD",
                              match_winner == "Gold Coast"             ~ "GCS",
                              match_winner == "Greater Western Sydney" ~ "GWS",
                              match_winner == "Melbourne"              ~ "MEL",
                              match_winner == "Western Bulldogs"       ~ "WBD",
                              match_winner == "West Coast"             ~ "WCE",
                              match_winner == "St Kilda"               ~ "STK",
                              match_winner == "Adelaide"               ~ "ADE",
                              match_winner == "Port Adelaide"          ~ "POR",
                              match_winner == "Richmond"               ~ "RIC"))

# # check if supercoach is attached to orginal dataframe
# afl_data_updated_sc_gp %>%
#   group_by(season) %>%
#   summarise_at(vars(supercoach_score), funs(mean(., na.rm=TRUE)))
```

```{r COACHES VOTES}

# read coaches votes
coach_votes_df <- read_csv("coaches_votes_clean3.csv") %>%
  select(1:5)

glimpse(coach_votes_df)

unique(coach_votes_df$Team)

# seperate player name and team, create helper to synch to main dataset
coach_votes <- coach_votes_df %>%
  mutate(Team = case_when(Team == "NMFC" ~ "NME",
                          Team == "MELB" ~ "MEL",
                          Team == "PORT" ~ "POR",
                          Team == "GCFC" ~ "GCS",
                          Team == "ADEL" ~ "ADE",
                          Team == "BL"   ~ "BRI",
                          Team == "RICH" ~ "RIC",
                          Team == "COLL" ~ "COL",
                          Team == "WB"   ~ "WBD",
                          Team == "CARL" ~ "CAR",
                          Team == "GEEL" ~ "GEE",
                          TRUE ~ Team),
         Player = case_when(Player == "Reilly O'Brien" ~ "Reilly OBrien",
                          Player == "Samuel Walsh" ~ "Sam Walsh",
                          Player == "Harrison McKay" ~ "Harry McKay",
                          Player == "Jordan De Goey" ~ "Jordan de Goey",
                          Player == "Mark O'Connor" ~ "Mark OConnor",
                          Player == "Tim O'Brien"   ~ "Tim OBrien",
                          Player == "Jaeger O'Meara" ~ "Jaeger OMeara",
                          Player == "Mitchell Georgiades" ~ "Mitch Georgiades",
                          Player == "Tom J Lynch"   ~ "Tom Lynch",
                          Player == "Josh J Kennedy" ~ "Josh Kennedy",
                          TRUE ~ Player),
         helper = paste0(Player,"_", Season,"_", Round,"_",Team))
  
################################################################################
# check players with coaches votes name are samw as afl_data_2
player_check <- filter(coach_votes, Votes > 0 & Season == 2021)

anti_join(player_check, afl_data_2, by = "helper")

################################################################################

# merge into orginal dataframe
afl_data_2 <- merge(afl_data_2, coach_votes, by = "helper", all.x = TRUE, all.y = FALSE)

glimpse(afl_data_2)
```


```{r Add supercoach data if I can get a better source}
# 
# # get 2020 + 2021 Supercoach data
# sc_data2020 <- fitzRoy::fetch_player_stats_footywire(2020)
# sc_data2021 <- fitzRoy::fetch_player_stats_footywire(2021)
# sc_data     <- rbind(sc_data2020, sc_data2021) %>% rename(player = Player)
# 
# sc_data2 <- sc_data %>% mutate(player = case_when(player == "Kamdyn Mcintosh" ~ "Kamdyn McIntosh",
#                                                    player == "Callum Brown" ~ "Callum L. Brown", #(COULD ALSO BE M BROWN)              
#                                                    player == "Matthew Taberner" ~ "Matt Taberner",
#                                                    player == "Matthew De Boer" ~ "Matt de Boer",
#                                                    player == "Harrison Himmelberg" ~ "Harry Himmelberg",
#                                                    player == "Lachlan Jones" ~ "Lachie Jones",
#                                                    player == "Patrick Ryder" ~ "Paddy Ryder",
#                                                    player == "Aaron Vandenberg" ~ "Aaron vandenBerg",
#                                                    player == "Cameron E-Yolmen" ~ "Cameron Ellis-Yolmen",
#                                                    player == "Cameron Sutcliffe" ~ "Cam Sutcliffe",
#                                                    player == "Denver G-Barras" ~ "Denver Grainger-Barras",
#                                                    player == "Jamarra U-Hagan" ~ "Jamarra Ugle-Hagan",
#                                                    player == "James Jordan" ~ "James Jordon",
#                                                    player == "Matthew Flynn" ~ "Matt Flynn",
#                                                    player == "Nic Reid" ~ "Nicholas Reid",
#                                                    player == "Nikolas Cox" ~ "Nik Cox",
#                                                    player == "Riley C-Dawkins" ~ "Riley Collier-Dawkins",
#                                                    player == "Thomas Sheridan" ~ "Tommy Sheridan",
#                                                    player == "Daniel Butler" ~ "Dan Butler",
#                                                    player == "Edward Curnow" ~ "Ed Curnow",
#                                                    player == "Sam P-Seton" ~ "Sam Petrevski-Seton",
#                                                    player == "Lachlan Plowman" ~ "Lachie Plowman",
#                                                    player == "Anthony M-Tipungwuti" ~ "Anthony McDonald-Tipungwuti",
#                                                    player == "Mitchell Brown" ~ "Mitch Brown",
#                                                    player == "Matthew Dea" ~ "Matt Dea",
#                                                    player == "Joshua Green" ~ "Josh Green",
#                                                    player == "Joshua Begley" ~ "Josh Begley",
#                                                    player == "Zachary Merrett" ~ "Zach Merrett",
#                                                    player == "David MacKay" ~ "David Mackay",
#                                                    player == "Cameron E-Yolmen" ~ "Cam Ellis-Yolmen",
#                                                    player == "Patrick McCartin" ~ "Paddy McCartin",
#                                                    player == "Nicholas Robertson" ~ "Nick Robertson",
#                                                    player == "Joshua Walker" ~ "Josh Walker",
#                                                    player == "Cameron Rayner" ~ "Cam Rayner",
#                                                    player == "Oliver Wines" ~ "Ollie Wines",
#                                                    player == "Darcy B-Jones" ~ "Darcy Byrne-Jones",
#                                                    player == "Sam P-Pepper" ~ "Sam Powell-Pepper",
#                                                    player == "Thomas Jonas" ~ "Tom Jonas",
#                                                    player == "Nathan Fyfe" ~ "Nat Fyfe",
#                                                    player == "Cameron McCarthy" ~ "Cam McCarthy",
#                                                    player == "Matthew Rosa" ~ "Matt Rosa",
#                                                    player == "Lachlan Weller" ~ "Lachie Weller",
#                                                    player == "Darcy Macpherson" ~ "Darcy MacPherson",
#                                                    player == "Nicholas Holman" ~ "Nick Holman",
#                                                    player == "Jamie MacMillan" ~ "Jamie Macmillan",
#                                                    player == "Ed V-Willis" ~ "Ed Vickers-Willis",
#                                                    player == "Luke D-Uniacke" ~ "Luke Davies-Uniacke",
#                                                    player == "Jaeger O'Meara" ~ "Jaeger OMeara",
#                                                    player == "Tim O'Brien" ~ "Tim OBrien",
#                                                    player == "Benjamin Stratton" ~ "Ben Stratton",
#                                                    player == "Samuel Murray" ~ "Sam Murray",
#                                                    player == "Will H-Elliott" ~ "Will Hoskin-Elliott",
#                                                    player == "Joshua Kelly" ~ "Josh Kelly",
#                                                    player == "Matthew De Boer" ~ "Matthew de Boer",
#                                                    player == "Samuel Reid" ~ "Sam Reid",
#                                                    player == "Lachlan Hunter" ~ "Lachie Hunter",
#                                                    player == "Jackson Macrae" ~ "Jack Macrae",
#                                                    player == "Matthew Suckling" ~ "Matt Suckling",
#                                                    player == "Timothy English" ~ "Tim English",
#                                                    player == "Thomas Liberatore" ~ "Tom Liberatore",
#                                                    player == "Joshua Wagner" ~ "Josh Wagner",
#                                                    player == "Alex N-Bullen" ~ "Alex Neal-Bullen",
#                                                    player == "Mitchell Hannan" ~ "Mitch Hannan",
#                                                    player == "Gary Jnr Ablett" ~ "Gary Ablett",
#                                                    player == "Mitchell Duncan" ~ "Mitch Duncan",
#                                                    player == "Lachlan Fogarty" ~ "Lachie Fogarty",
#                                                    player == "Thomas Stewart" ~ "Tom Stewart",
#                                                    player == "Dominic Sheed" ~ "Dom Sheed",
#                                                    player == "Mark Lecras" ~ "Mark LeCras",
#                                                    player == "Bradley Sheppard" ~ "Brad Sheppard",
#                                                    player == "Nicholas Naitanui" ~ "Nic Naitanui",
#                                                    player == "Josh P. Kennedy" ~ "Josh Kennedy",
#                                                    player == "Cameron O'Shea" ~ "Cameron OShea",
#                                                    player == "Matthew Scharenberg" ~ "Matt Scharenberg",
#                                                    player == "Timothy Broomhead" ~ "Tim Broomhead",
#                                                    player == "Mitchell Crowden" ~ "Mitch Crowden",
#                                                    player == "Daniel Hannebery" ~ "Dan Hannebery",
#                                                    player == "Mark O'Connor" ~ "Mark OConnor",
#                                                    player == "Thomas Sheridan" ~ "Tom Sheridan",
#                                                    player == "Nicholas Coffield" ~ "Nick Coffield",
#                                                    player == "William Langford" ~ "Will Langford",
#                                                    player == "Mitchell Wallis" ~ "Mitch Wallis",
#                                                    player == "Jordan De Goey" ~ "Jordan de Goey",
#                                                    player == "Nicholas Graham" ~ "Nick Graham",
#                                                    player == "Lochie O'Brien" ~ "Lochie OBrien",
#                                                    player == "Joshua Kennedy" ~ "Josh Kennedy",
#                                                    player == "George H-Smith" ~ "George Horlin-Smith",
#                                                    player == "Thomas Boyd" ~ "Tom Boyd",
#                                                    player == "Daniel Robinson" ~ "Dan Robinson",
#                                                    player == "Nicholas Shipley" ~ "Nick Shipley",
#                                                    player == "Christopher Mayne" ~ "Chris Mayne",
#                                                    player == "Samuel Wright" ~ "Sam Wright",
#                                                    player == "Edward Phillips" ~ "Ed Phillips",
#                                                    player == "Mitchell Lewis" ~ "Mitch Lewis",
#                                                    player == "Matthew Buntine" ~ "Matt Buntine",
#                                                    player == "Thomas Murphy" ~ "Tom Murphy",
#                                                    player == "Joshua Schoenfeld" ~ "Josh Schoenfeld",
#                                                    player == "Bradley Lynch" ~ "Brad Lynch",
#                                                    player == "Harrison Petty" ~ "Harry Petty",
#                                                    player == "Jonathan O'Rourke" ~ "Jonathan ORourke",
#                                                    player == "Jay K-Harris" ~ "Jay Kennedy-Harris",
#                                                    player == "Colin O'Riordan" ~ "Colin ORiordan",
#                                                    player == "Lachlan Henderson" ~ "Lachie Henderson",
#                                                    player == "Zachary Williams" ~ "Zac Williams",
#                                                    player == "Samuel Collins" ~ "Sam Collins",
#                                                    player == "Lachlan Schultz" ~ "Lachie Schultz",
#                                                    player == "Reilly O'Brien" ~ "Reilly OBrien",
#                                                    player == "Zachary Clarke" ~ "Zac Clarke",
#                                                    player == "Justin Mcinerney" ~ "Justin McInerney",
#                                                    player == "Robert Young" ~ "Robbie Young",
#                                                    player == "Mitchell Hinge" ~ "Mitch Hinge",
#                                                    player == "Callum C-Jones" ~ "Callum Coleman-Jones",
#                                                    player == "Bradley Scheer" ~ "Brad Scheer",
#                                                    player == "Derek E-Smith" ~ "Derek Eggmolesse-Smith",
#                                                    player == "Ian Hill" ~ "Bobby Hill",
#                                                    player == "Joshua Deluca" ~ "Josh Deluca",
#                                                    player == "Brandon Z-Thatcher" ~ "Brandon Zerk-Thatcher",
#                                                    player == "Zachary Sproule" ~ "Zach Sproule",
#                                                    player == "Thomas Berry" ~ "Tom Berry",
#                                                    player == "Lachlan Ash" ~ "Lachie Ash",
#                                                    player == "Harrison Jones" ~ "Harry Jones",
#                                                    player == "Minairo Frederick" ~ "Michael Frederick",
#                                                    player == "Matthew Ling" ~ "Matt Ling",
#                                                    player == "Bradley Close" ~ "Brad Close",
#                                                    player == "Xavier O'Halloran" ~ "Xavier OHalloran",
#                                                    player == "Matt Cottrell" ~ "Matthew Cottrell",
#                                                    player == "Thomas Hutchesson" ~ "Tom Hutchesson",
#                                                    player == "Xavier O'Neill" ~ "Xavier ONeill",
#                                                    player == "Matt Owies" ~ "Matthew Owies",
#                                                    TRUE ~ player))
# 
# # find differencs in names
# afl_data_names <- afl_data %>% dplyr::filter(season > 2019) %>%  select(player) 
# sc_data_names   <- sc_data2  %>% select(player)
# 
# different_names <- dplyr::anti_join(afl_data_names,sc_data_names, by = "player")
# 
# 
# sc_data3 <-  sc_data2 %>% 
#              mutate(Round  = case_when(Round == "Grand Final" ~ 28,   
#                                        Round == "Preliminary Final" ~ 27,
#                                        Round == "Preliminary Finals" ~ 27,
#                                        Round == "Semi Final" ~ 26,
#                                        Round == "Semi Finals" ~ 26,
#                                        Round == "Elimination Final" ~ 25,
#                                        Round == "Qualifying Final" ~ 25,
#                                        Round == "Finals Week 1" ~ 25,
#                                        Round == "Round 24" ~ 24,
#                                        Round == "Round 23" ~ 23,
#                                        Round == "Round 22" ~ 22,
#                                        Round == "Round 21" ~ 21,
#                                        Round == "Round 20" ~ 20,
#                                        Round == "Round 19" ~ 19,
#                                        Round == "Round 18" ~ 18,
#                                        Round == "Round 17" ~ 17,
#                                        Round == "Round 16" ~ 16,
#                                        Round == "Round 15" ~ 15,
#                                        Round == "Round 14" ~ 14,
#                                        Round == "Round 13" ~ 13,
#                                        Round == "Round 12" ~ 12,
#                                        Round == "Round 11" ~ 11,
#                                        Round == "Round 10" ~ 20,
#                                        Round == "Round 9" ~ 9,
#                                        Round == "Round 8" ~ 8,
#                                        Round == "Round 7" ~ 7,
#                                        Round == "Round 6" ~ 6,
#                                        Round == "Round 5" ~ 5,
#                                        Round == "Round 4" ~ 4,
#                                        Round == "Round 3" ~ 3,
#                                        Round == "Round 2" ~ 2,
#                                        Round == "Round 1" ~ 1),
#                      Team = case_when(Team == "Geelong"                ~ "GEE",
#                                       Team == "Hawthorn"               ~ "HAW",
#                                       Team == "Brisbane Lions"         ~ "BRI",
#                                       Team == "Brisbane"               ~ "BRI",
#                                       Team == "Collingwood"            ~ "COL",
#                                       Team == "North Melbourne"        ~ "NME",
#                                       Team == "Fremantle"              ~ "FRE",
#                                       Team == "Essendon"               ~ "ESS",
#                                       Team == "Carlton"                ~ "CAR",
#                                       Team == "Sydney"                 ~ "SYD",
#                                       Team == "Gold Coast"             ~ "GCS",
#                                       Team == "GWS"                    ~ "GWS",
#                                       Team == "Melbourne"              ~ "MEL",
#                                       Team == "Western Bulldogs"       ~ "WBD",
#                                       Team == "West Coast"             ~ "WCE",
#                                       Team == "St Kilda"               ~ "STK",
#                                       Team == "Adelaide"               ~ "ADE",
#                                       Team == "Port Adelaide"          ~ "POR",
#                                       Team == "Richmond"               ~ "RIC")) %>%
#   mutate(helper = paste0(player,"_", Season,"_", Round,"_",Team)) %>%
#   select(helper, SC)
# 
# # combine supercoach data with original data frame
# orignal_data_2020_2021  <- afl_data %>% filter(season == 2020 | season == 2021)
# orignal_data_below_2020 <- afl_data %>% filter(season <= 2020)
# 
# binded_2020_2021 <- left_join(orignal_data_2020_2021, sc_data, by = "helper") %>%
#                     select(-supercoach_score) %>%
#                     dplyr::rename(supercoach_score = SC)
# left_
# afl_data_updated_sc <- rbind(orignal_data_below_2020, binded_2020_2021)
```

```{r Update names and order of varaibles}


afl_data_3 <- afl_data_2 %>%
  select(helper,
         match_id,
         id           = player_id,
         first_name   = player_first_name,
         last_name    = player_last_name,
         team         = player_team,
         player,
         games_played,
         position     = position_new,
         position_old = player_position,
         season,
         round,
         date,
         kicks,
         handballs,
         marks,
         behinds,
         hitouts,
         tackles,
         free_kicks_for,
         free_kicks_against,
         supercoach   = supercoach_score,
         disposals,
         goals,
         score_involvements,
         coach_votes = Votes.y,
         brownlow_votes,
         match_winner) %>%
  mutate(dfs_score   = (kicks * 3) + (handballs * 2) + (marks * 3) + (goals * 6) + behinds + hitouts + (tackles * 4) + free_kicks_for - (free_kicks_against * 3),
         coach_votes = ifelse(is.na(coach_votes), 0, coach_votes))
   


r10_check <- dplyr::filter(afl_data, season == 2021)      

unique(r10_check$round)


```

```{r Add missing 2020 brownlow votes}
# afl_data_3a <- afl_data_3 %>% arrange(match_id) %>% select(helper, brownlow_votes, everything()) %>% edit()
updated_brownlow_df <- afl_data_4 %>% select(-coach_votes)

correct_cv_data <- dplyr::select(afl_data_3, c(helper, coach_votes))

# merge the above correct_cv with updated_brownlow
afl_data_4_updated <- merge(updated_brownlow_df, correct_cv_data, by = "helper", all.x = TRUE, all.y = FALSE) %>%
  mutate(coach_votes = ifelse(is.na(coach_votes), 0, coach_votes)) 

glimpse(afl_data_4_updated)
# MERGE PREVIOUSLY MANUALLY EDITED BROWNLOW VOTES
```


# BECAUSE ADDING IN UPDATED COACHES VOTES AFTERWARDS, THESE CLOSE CODE CHUNKS HAVE BEEN RUN ALREADY


```{r Feature creation}




# create winning team variable
afl_data_4 <- afl_data_3a %>% 
      mutate(winning_team = case_when(team == match_winner ~ 1,
                                      team != match_winner ~ 0,
                                        is.na(match_winner) ~ 0)) %>%
      relocate(c(winning_team, match_winner), .after = brownlow_votes)


# create cumulative
afl_data_4 <- afl_data_4 %>% 
  arrange(date) %>%
  group_by(id) %>%
  mutate(previous_brownlow_vote    = lag(brownlow_votes),
         cumulative_brownlow_votes = cumsum(brownlow_votes) - brownlow_votes,
         relative_brownlow_votes   = cumulative_brownlow_votes/games_played) %>%
  select(relative_brownlow_votes,brownlow_votes, cumulative_brownlow_votes, everything()) %>%
  ungroup()




# create umpire_brownlow

```



```{r Correaltions}
last_five_seasons <- dplyr::filter(afl_data_4, season == 2019)


data <- last_five_seasons
cor_data <- data %>% select_if(is.numeric)
correlations_df <- corrr::correlate(cor_data)
bv_cors <- focus(correlations_df, brownlow_votes)
bv_cors <- arrange(bv_cors, brownlow_votes) 
bv_cors <- mutate(bv_cors, brownlow_votes = round(brownlow_votes,2))
```

```{r}

# Variables
# Supercoach
# DFS
# Rating points
# Kicks
# Disposals
# Effective Kicks
# Score involvements
# Effective disposals
# Hitouts
# Goals
# shots_at_goal
# CP
# marks_I50
# metres_gained
# handballs
# clearances
# marks
#intercept_marks

# ALL
handballs	0.25			
clearances	0.27			
kicks	0.28			
effective_disposals	0.30			
score_involvements	0.30			
CP	0.30			
rating_points	0.32			
disposals	0.33			
dfs_score	0.38			
supercoach	0.44	

# KEYD
intercept_marks	0.15			
UP	0.16			
rating_points	0.17			
effective_kicks	0.18			
kicks	0.18			
marks	0.18			
effective_disposals	0.20			
disposals	0.20			
dfs_score	0.22			
supercoach	0.26

# GEND
marks	0.16			
rating_points	0.17			
metres_gained	0.17			
effective_kicks	0.19			
kicks	0.20			
UP	0.21			
effective_disposals	0.22			
disposals	0.23			
dfs_score	0.23			
supercoach	0.27

# MID
clearances	0.31			
handballs	0.31			
score_involvements	0.32			
kicks	0.32			
CP	0.34			
rating_points	0.35			
effective_disposals	0.37			
disposals	0.40			
dfs_score	0.41			
supercoach	0.48	

# MIDF
CP	0.35			
effective_kicks	0.36			
metres_gained	0.37			
score_involvements	0.37			
rating_points	0.39			
effective_disposals	0.39			
kicks	0.41			
disposals	0.43			
dfs_score	0.46			
supercoach	0.54

# GENF
marks_I50	0.22			
effective_kicks	0.22			
kicks	0.23			
disposals	0.23			
score_involvements	0.29			
shots_at_goal	0.29			
dfs_score	0.31			
rating_points	0.31			
goals	0.36			
supercoach	0.37

# KEYF
metres_gained	0.31			
effective_kicks	0.32			
kicks	0.33			
marks_I50	0.34			
score_involvements	0.36			
shots_at_goal	0.39			
rating_points	0.40			
dfs_score	0.43			
goals	0.45			
supercoach	0.50

# RUCK
CP	0.24			
hitouts	0.24			
effective_kicks	0.26			
rating_points	0.27			
kicks	0.27			
effective_disposals	0.27			
score_involvements	0.28			
disposals	0.30			
dfs_score	0.37			
supercoach	0.41	
```


```{r Test VIF in LM}

#KEYD                  #GEND                #MID                 #RUCK              #MIDF              #GENF              #KEYF
# supercoach           supercoach           supercoach           supercoach         supercoach         supercoach         supercoach
# hitouts              hitouts              hitouts              hitouts            hitouts            hitouts            hitouts
# goals                goals                goals                goals              goals              goals              goals
# marks_I50            marks_I50            marks_I50            marks_I50          marks_I50          marks_I50          marks_I50
# clearances           clearances           clearanes            clearanes          clearanes          clearanes          clearances
# marks                marks                marks                marks              marks              marks              marks
# handballs            handballs            handballs            handballs          handballs          handballs          handballs
# metres_gained        metres_gained        metres_gained        metres_gained      metres_gained      metres_gained      metres_gained
# intercept_marks      intercept_marks      intercept_marks      intercept_marks    intercept_marks    intercept_marks    interept_marks
# score_involvements   score_involvements   score_involvements   score_involvements score_involvements score_involvements ------------





#KEYD
keyd_df <- afl_data_3 %>% dplyr::filter(position == "KeyD")
keyd_model <- lm(brownlow_votes ~ disposals + coach_votes + hitouts + goals + clearances + marks  + metres_gained + intercept_marks + score_involvements , data = afl_data_3)
check_collinearity(keyd_model)
# removed = effective_kicks + kicks + effective disposals + disposals + rating_points + shots_at_goal

# GEND
gend_df <- afl_data_3 %>% dplyr::filter(position == "GenD")
gend_model <- lm(brownlow_votes ~ disposals + hitouts + goals + shots_at_goal + marks_I50 + clearances + marks +  metres_gained + intercept_marks + score_involvements , data = gend_df)
check_collinearity(gend_model)
# removed = disposals + effective_disposals + rating_points

#MID
mid_df <- afl_data_3 %>% dplyr::filter(position == "Mid")
mid_model <- lm(brownlow_votes ~ disposals + hitouts + goals + shots_at_goal + marks_I50 + clearances + marks  + metres_gained + intercept_marks + score_involvements, data = mid_df)
check_collinearity(mid_model)
# removed = effective_disposals + 


#RUCK
ruck_df <- afl_data_3 %>% dplyr::filter(position == "Ruck")
ruck_model <- lm(brownlow_votes ~ disposals + effective_kicks + hitouts + goals + shots_at_goal + marks_I50 + clearances + marks  + metres_gained + intercept_marks + score_involvements, data = ruck_df)
check_collinearity(ruck_model)


#MIDF
midf_df <- afl_data_3 %>% dplyr::filter(position == "MidF")
midf_model <- lm(brownlow_votes ~ supercoach + hitouts + goals + shots_at_goal + marks_I50 + clearances + marks + handballs + metres_gained + intercept_marks + score_involvements, data = midf_df)
check_collinearity(midf_model)

#GENF
genf_df <- afl_data_3 %>% dplyr::filter(position == "GenF")
genf_model <- lm(brownlow_votes ~ supercoach  + hitouts + goals + marks_I50 + clearances + marks + handballs + metres_gained + intercept_marks + score_involvements + CP, data = genf_df)
check_collinearity(genf_model)

#KEYF
keyf_df <- afl_data_3 %>% dplyr::filter(position == "KeyF")
keyf_model <- lm(brownlow_votes ~ supercoach + hitouts + goals + marks_I50 + clearances + marks + handballs + metres_gained + intercept_marks , data = keyf_df)
check_collinearity(keyf_model)


check_collinearity(model)
```

```{r Test distributions}

# correlations iwth brownlow vites above 0.25 and VIF below 5
# supercoach
# disposals
# rating_points
# CP
# score_involvements - RIGHT TAILED SKEWED
# clearances - RIGHT TAILED SKEWED

ggplot(afl_data_3, aes(x = coach_votes)) +
  geom_histogram() +
  facet_wrap(~ position)
```

```{r Exploration of Brownlow Votes}
no_zeros <- filter(data, brownlow_votes > 0)
ggplot(no_zeros, aes(x = brownlow_votes)) +
  geom_bar() +
  facet_wrap(~ position)

```


```{r Data manupulation before model}

# Fix 2020 statistics that are important
afl_data_not_2020 <- filter(afl_data_4, season != 2020)
afl_data_2020 <- afl_data_4 %>%
  filter(season == 2020) %>%
  mutate(disposals = disposals * 1.2,
         score_involvements = score_involvements * 1.2,
         goals = goals *1.2,
         dfs_score = dfs_score *1.2)

afl_data_4 <- rbind(afl_data_not_2020, afl_data_2020)


# Convert brownlow votes into factors
afl_data_4$brownlow_votes <- factor(afl_data_4$brownlow_votes, levels = c(0, 1, 2, 3), ordered = TRUE)
  

# Log transform score_involvements and clearances 
```



```{r Exploration Plots}

 data <- filter(afl_data_4, season == 2019)
 noruck <- filter(data, position == "Ruck")

# Disposals
ggplot(data, aes(x = brownlow_votes, y = coach_votes, col = position)) +
  geom_point(position = 'jitter') +
  geom_smooth(method = lm,
              se     = FALSE,
              size   = .5, 
              alpha  = .8) 

# hitouts
ggplot(noruck, aes(x = brownlow_votes, y = hitouts, col = position)) +
  geom_point(position = 'jitter') +
  geom_smooth(method = lm,
              se     = FALSE,
              size   = .5, 
              alpha  = .8) # to add regression line


# goals
ggplot(data, aes(x = brownlow_votes, y = goals, col = position)) +
  geom_point(position = 'jitter') +
  geom_smooth(method = lm,
              se     = FALSE,
              size   = .5, 
              alpha  = .8) # to add regression line

# marks inside 50
ggplot(data, aes(x = brownlow_votes, y = marks_I50, col = position)) +
  geom_point(position = 'jitter') +
  geom_smooth(method = lm,
              se     = FALSE,
              size   = .5, 
              alpha  = .8) # to add regression line

# clearances
ggplot(data, aes(x = brownlow_votes, y = winning_team, col = position)) +
  geom_point(position = 'jitter') +
  geom_smooth(method = lm,
              se     = FALSE,
              size   = .5, 
              alpha  = .8) # to add regression line



# marks
ggplot(data, aes(x = brownlow_votes, y = marks, col = position)) +
  geom_point(position = 'jitter') +
  geom_smooth(method = lm,
              se     = FALSE,
              size   = .5, 
              alpha  = .8) # to add regression line

# handballs
ggplot(data, aes(x = brownlow_votes, y = handballs, col = position)) +
  geom_point(position = 'jitter') +
  geom_smooth(method = lm,
              se     = FALSE,
              size   = .5, 
              alpha  = .8) # to add regression line


# metres gained
ggplot(data, aes(x = brownlow_votes, y = metres_gained, col = position)) +
  geom_point(position = 'jitter') +
  geom_smooth(method = lm,
              se     = FALSE,
              size   = .5, 
              alpha  = .8) # to add regression line

# metres gained
ggplot(data, aes(x = brownlow_votes, y = metres_gained, col = position)) +
  geom_point(position = 'jitter') +
  geom_smooth(method = lm,
              se     = FALSE,
              size   = .5, 
              alpha  = .8) # to add regression line

# score_involvements
ggplot(data, aes(x = brownlow_votes, y = score_involvements, col = position)) +
  geom_point(position = 'jitter') +
  geom_smooth(method = lm,
              se     = FALSE,
              size   = .5, 
              alpha  = .8) # to add regression line

# intercept_marks
ggplot(data, aes(x = brownlow_votes, y = intercept_marks, col = position)) +
  geom_point(position = 'jitter') +
  geom_smooth(method = lm,
              se     = FALSE,
              size   = .5, 
              alpha  = .8) # to add regression line
```


NOTES:
- Supercoach: similar slopes, different intercepts (could add different slopes)
- Hitouts: ruck different slope and intercept from all other positions
- Goals: differnt slope and intercepts (KeyF, GenF, MidF all positive correlation, other position no correlation)
- Marks I50 same as Goals
- Marks same slopes differnt intercepts
- Clearances different slopes and intercepts
- Handballs: same slopes differnt intercepts
- Metres gained: same slopes differnt intercepts
- Score involvements: different slopes and intercepts
- Intercept marks: different slopes and intercepts




```{r Run Bayesian Multilevel Model 2}

training_test <- afl_data_4 %>% filter(season > 2017 & season < 2021) 
test_test     <- afl_data_4 %>% filter(season == 2019) 

#####################
# CREATE / RUN MODEL
#####################

# Assumptions
#1. removed disposals from random effect of postion as all positions have similar slopes and intercepts
#2.


ncores = detectCores() # find how many processing cores the computer has
rstan_options(auto_write = TRUE)
options(mc.cores = parallel::detectCores())

------------------------------------------------
# score_involvements - RIGHT TAILED SKEWED
# clearances - RIGHT TAILED SKEWED
------------------------------------------------

  
# Adjacent Category  
mod2a <- brm(brownlow_votes ~ supercoach +
             (1 | position),
           data    = training_test,
           family  = acat(),
           iter    = 2000,         # maybe look at increasesing this 
           chains  = ncores,
           cores   = ncores,
           control = list(adapt_delta = 0.98))

# Adjacent Category with Category-Specific Effects
mod2b <- brm(brownlow_votes ~ cs(supercoach) +
             (1 | position),
           data    = training_test,
           family  = acat(),
           iter    = 2000,         # maybe look at increasesing this 
           chains  = ncores,
           cores   = ncores,
           control = list(adapt_delta = 0.98))

# Adjacent Category with Category-Specific Effects with RATING POINTS
mod2c <- brm(brownlow_votes ~ cs(rating_points) +
             (1 | position),
           data    = training_test,
           family  = acat(),
           iter    = 2000,         # maybe look at increasesing this 
           chains  = ncores,
           cores   = ncores,
           control = list(adapt_delta = 0.98))

# Adjacent Category with winning_team and Category-Specific Effects with Supercoach
mod2d <- brm(brownlow_votes ~ cs(supercoach) + winning_team +
             (1 + winning_team | position),
           data    = training_test,
           family  = acat(),
           iter    = 2000,         # maybe look at increasesing this 
           chains  = ncores,
           cores   = ncores,
           control = list(adapt_delta = 0.98))

# Adjacent Category with winning_team and Category-Specific Effects with Supercoach
mod2e <- brm(brownlow_votes ~ cs(supercoach) + cs(winning_team) +
             (1 + winning_team | position),
           data    = training_test,
           family  = acat(),
           iter    = 2000,         # maybe look at increasesing this 
           chains  = ncores,
           cores   = ncores,
           control = list(adapt_delta = 0.98))

# Adjacent Category with winning_team and Category-Specific Effects with Supercoach
mod2f <- brm(brownlow_votes ~ cs(supercoach + winning_team + disposals) +
             (1 + winning_team + disposals | position),
           data    = training_test,
           family  = acat(),
           iter    = 2000,         # maybe look at increasesing this 
           chains  = ncores,
           cores   = ncores,
           control = list(adapt_delta = 0.98))

# Adjacent Category with cs(winning_team) + sc + d + si
mod2g <- brm(brownlow_votes ~ cs(winning_team) + supercoach + disposals + score_involvements +
             (1 + winning_team | position),
           data    = training_test,
           family  = acat(),
           iter    = 2000,         # maybe look at increasesing this 
           chains  = ncores,
           cores   = ncores,
           control = list(adapt_delta = 0.98))



# Adjacent Category with cs(winning_team) + sc + d +  + metres_gained
mod2h <- brm(brownlow_votes ~ cs(winning_team) + supercoach + disposals + score_involvements + metres_gained +
             (1 + winning_team | position),
           data    = training_test,
           family  = acat(),
           iter    = 2000,         # maybe look at increasesing this 
           chains  = ncores,
           cores   = ncores,
           control = list(adapt_delta = 0.98))


# Adjacent Category with cs(winning_team) + sc + d +  + metres_gained
mod2i <- brm(brownlow_votes ~ cs(winning_team + goals) + supercoach + disposals + score_involvements +
             (1 + winning_team + goals | position),
           data    = training_test,
           family  = acat(),
           iter    = 2000,         # maybe look at increasesing this 
           chains  = ncores,
           cores   = ncores,
           control = list(adapt_delta = 0.98))


# Adjacent Category with cs(winning_team) + sc + d +  + metres_gained
mod2j <- brm(brownlow_votes ~ cs(winning_team + goals + relative_brownlow_votes) + supercoach + disposals + score_involvements +
             (1 + winning_team + goals + relative_brownlow_votes | position),
           data    = training_test,
           family  = acat(),
           iter    = 2000,         # maybe look at increasesing this 
           chains  = ncores,
           cores   = ncores,
           control = list(adapt_delta = 0.98))


tictoc::tic()
# TRAINING on last 3 season 2018,2019,2020 - ADDED MORE DATA comapred to ONE SEAON IN LAST 10 MODELS
mod2k <- brm(brownlow_votes ~ cs(winning_team + goals + relative_brownlow_votes) + supercoach + disposals + score_involvements + 
             (1 + winning_team + goals + relative_brownlow_votes | position),
           data    = training_test,
           family  = acat(),
           iter    = 2000,         # maybe look at increasesing this 
           chains  = ncores,
           cores   = ncores,
           control = list(adapt_delta = 0.98))

tictoc::toc()



# TRAINING on last 3 season 2018,2019,2020 - ADDED MORE DATA comapred to ONE SEAON IN LAST 10 MODELS
mod2l <- brm(brownlow_votes ~ cs(winning_team + goals + relative_brownlow_votes) + dfs_score + disposals + score_involvements + 
             (1 + winning_team + goals + relative_brownlow_votes | position),
           data    = training_test,
           family  = acat(),
           iter    = 2000,         # maybe look at increasesing this 
           chains  = ncores,
           cores   = ncores,
           control = list(adapt_delta = 0.98))




mod2m <- brm(brownlow_votes ~ cs(winning_team + goals + relative_brownlow_votes) + coach_votes + dfs_score + disposals + score_involvements + 
             (1 + winning_team + goals + relative_brownlow_votes | position),
           data    = training_test,
           family  = acat(),
           iter    = 2000,         # maybe look at increasesing this 
           chains  = ncores,
           cores   = ncores,
           control = list(adapt_delta = 0.98))

# DIVERGENT TRANSITIONS: if there is a warning, increase the alpha_delta (deafult = 0.8). Will slow down model but decrease divergent transitons. Can also lowerinh the number of iterations
# CHECK RHAT:  only use the sample if R-hat is less than 1.1 
# CHECK Effect Sample: should be as large as possible. 1000 or above is usally fine
# ESS:   the higher the ESS the better.  Bulk and Tail ESS should be greater than 100 times the number of chains. 4 chains = 400 Bulk-ESS

# FIXES: if rhat or ESS are not meet. Try increasing the iterations (default = 2000)


# ASSESSING THE MODEL --------------------------------------------------------------------------------------------------

model <- mod2m

# use summary to look at rhat (needs to be at 1 or very close to.) and ESS (needs to be at around 1000
summary(model)

# use this for continous models as it shows if the predictive runs are similar to the orginal data
pp_check(model, nsamples = 2)        

# use this to look at the catipillars - they should be hairy showing the runs have converged/mixed
plot(model)            

# use the below to check the posterior results

conditional_effects(model, categorical = TRUE)


# use ranef to estimate the relative size of the randim effects per group
ranef(model) 



# Comparing models - low the score the better
looa <- loo(mod2a)
loob <- loo(mod2b)
looc <- loo(mod2c)
lood <- loo(mod2d)
looe <- loo(mod2e)
loof <- loo(mod2e)
loog <- loo(mod2g)
looh <- loo(mod2h)
looi <- loo(mod2i)
looj <- loo(mod2j)
look <- loo(mod2k)
lool <- loo(mod2l)
loom <- loo(mod2m)
loo_compare(looa, loob, looc, lood, looe, loog, looh, looi, looj, loom)



  # if two models are similar LOO and from the same family it shows the advanced model is not providing any extra infomation
tictoc::toc()


```


```{r Predictions}


test_test     <- afl_data_4_updated %>% dplyr::filter(season == 2021)
# test_test     <- test_test[!is.na(test_test$supercoach), ]
# filter if want to look at one round
# test_test2 <- dplyr::filter(test_test, round == 1, team == c("BRI",  "HAW" ))
# test_test2$brownlow_votes <- as.numeric(test_test2$brownlow_votes)

##To know the current storage capacity
memory.limit()
## To increase the storage capacity
memory.limit(size=56000)
    
## I did this to increase my storage capacity to 7GB
# Run predictions
samples = 1000
model_selected = mod2m
predictions1 <- predicted_draws(model_selected, test_test, ndraws = samples, allow_new_levels = TRUE) %>%
  mutate(.prediction = as.numeric(.prediction))


#--------------------------------------------------------------------------------
# Check predictions are 0-3 or 1-4 and if so change
predictions1 <- predictions1 %>% mutate(prediction = case_when(.prediction == 1 ~ 0,
                                                               .prediction == 2 ~ 1,
                                                               .prediction == 3 ~ 2,
                                                               .prediction == 4 ~ 3,)) %>%
  select(prediction, everything())



##################################################################################
# MATCH TO MATCH
##################################################################################

match_match <- predictions1 %>%
  ungroup() %>%
  select(c(.draw, prediction, match_id, helper, player, team, round, dfs_score, disposals, goals, score_involvements, winning_team, coach_votes, brownlow_votes)) %>%
  mutate(helper2 = paste0(player, team)) %>%
  dplyr::group_by(.draw, match_id) %>%
  mutate(is_match_1 = ifelse(rank(desc(prediction), ties.method = "min") <2, 1, 0),
         is_match_2 = ifelse(rank(desc(prediction), ties.method = "min") >1 & rank(desc(prediction), ties.method = "min") <3, 1, 0),
         is_match_3 = ifelse(rank(desc(prediction), ties.method = "min") >2 & rank(desc(prediction), ties.method = "min") <4, 1, 0)) %>%
  ungroup() %>%
  dplyr::group_by(helper) %>%
  mutate(predicted_votes   = mean(prediction),
         sd_votes          = round(standard_error(prediction) * 10, 2),
         match_1_chance = sum(is_match_1)/10,
         match_2_chance = sum(is_match_2)/10,
         match_3_chance = sum(is_match_3)/10) %>%
  group_by(helper) %>%
  arrange(match_id) %>%
  dplyr::filter(duplicated(helper) == FALSE) %>%
  select(match_id, round, helper, helper2, team, predicted_votes, sd_votes, match_1_chance, match_2_chance, match_3_chance, dfs_score, disposals, goals, score_involvements, winning_team, coach_votes) 

########## rouinded pred
round_pred <- match_match %>%
 group_by(match_id) %>%
  mutate(rounded_pred = case_when((rank(desc(predicted_votes), ties.method = "random") == 1) ~ 3,
                                  (rank(desc(predicted_votes), ties.method = "random") == 2) ~ 2,
                                  (rank(desc(predicted_votes), ties.method = "random") == 3) ~ 1,
                                  (rank(desc(predicted_votes), ties.method = "random") >3) ~ 0)) %>%
  mutate(rank1 = rank(desc(predicted_votes), ties.method = "first")) %>%
  select(rounded_pred, predicted_votes, everything())

# grouped by helper
final_round_pred <- round_pred %>%
  group_by(helper2) %>%
  mutate(round_final_pred = sum(rounded_pred),
         total_pred       = sum(predicted_votes)) %>%
  dplyr::filter(duplicated(helper2) == FALSE) %>%
  select(helper2, round_final_pred, total_pred)

test2 <- filter(round_pred , match_id == 15987)

write_csv(match_match, "match_match.csv")

##################################################################################
# ACCURACY
##################################################################################


# add top 3 votes to use for accuarcy
match_match2 <- match_match %>%
  dplyr::group_by(match_id) %>%
  mutate(predicted_1st  = rank(desc(match_1_chance)),
         predicted_top3 = case_when(predicted_1st == 1 ~ 3,
                                    predicted_1st == 2 ~ 2,
                                    predicted_1st == 3 ~ 1),
         predicted_top3 = ifelse(is.na(predicted_top3), 0, predicted_top3),
         accuracy       = ifelse(predicted_top3 == brownlow_votes, 1, 0))


# filter match to match df to only have players who polled votes
match_match3 <- match_match2 %>% filter(brownlow_votes > 0)
match_match4 <- match_match2 %>% filter(brownlow_votes > 2)
match_match5 <- match_match2 %>% filter(brownlow_votes == 2)
match_match6 <- match_match2 %>% filter(brownlow_votes == 1)

overall_accuracy  = (sum(match_match2$accuracy) / nrow(match_match2)) *100
polled_accuracy   = (sum(match_match3$accuracy) / nrow(match_match3)) *100
polled_3_accuracy = (sum(match_match4$accuracy) / nrow(match_match4)) *100
polled_2_accuracy = (sum(match_match5$accuracy) / nrow(match_match5)) *100
polled_1_accuracy = (sum(match_match6$accuracy) / nrow(match_match6)) *100

accuracy_df <- data.frame(type = c("all", "polled_only", "polled_3", "polled_2", "polled_1"),
                          accuarcy = c("93%", "36%", "56%", "32%", "20%"))


test2 <- filter(predictions2 , match_id == 15808)

cor(match_match2$brownlow_votes, match_match2$predicted_top3) 


##################################################################################
# ROUNDED PREDICTIONS using match_match
##################################################################################

rounded_pred <- match_match



##################################################################################
# OVERALL PREDICTIONS
##################################################################################



prediction3 <- predictions1 %>%
  ungroup() %>%
  select(c(.draw, prediction, match_id, helper, player, team, round, dfs_score, disposals, goals, score_involvements, winning_team, coach_votes)) %>%
  mutate(helper2 = paste0(player, team)) %>%
  dplyr::group_by(.draw, helper2) %>%
  mutate(total_votes_per_draw = sum(prediction)) %>%
  dplyr::filter(duplicated(.draw) == FALSE) %>%
  dplyr::group_by(.draw) %>%
  mutate(is_top_1   = ifelse(rank(desc(total_votes_per_draw)/10) <2, 1, 0),
         is_top_2   = ifelse(rank(desc(total_votes_per_draw)/10) <3, 1, 0),
         is_top_3   = ifelse(rank(desc(total_votes_per_draw)/10) <4, 1, 0),
         is_top_5   = ifelse(rank(desc(total_votes_per_draw)/10) <6, 1, 0),
         is_top_10  = ifelse(rank(desc(total_votes_per_draw)/10) <11, 1, 0),
         is_top_20  = ifelse(rank(desc(total_votes_per_draw)/20) <21, 1, 0)) %>%
  ungroup() %>%
  dplyr::group_by(.draw, team) %>%
  mutate(team_top   = ifelse(rank(desc(total_votes_per_draw)/samples) <2, 1, 0),
         team_votes = sum(total_votes_per_draw)) %>%
  dplyr::group_by(helper2) %>%
  mutate(predicted_votes   = median(total_votes_per_draw),
         sd_votes    = round(standard_error(total_votes_per_draw) * 10, 2),
         top_1_chance = sum(is_top_1)/10,
         top_2_chance = sum(is_top_2)/10,
         top_3_chance = sum(is_top_3)/10,
         top_5_chance = sum(is_top_5)/10,
         top_10_chance = sum(is_top_10)/10,
         top_20_chance = sum(is_top_20)/10,
         team_top_chance = sum(team_top)/10)  %>%
  dplyr::group_by(team) %>%
  mutate(team_votes_chance =sum(team_votes)/10) %>%
  arrange(prediction) %>%
  dplyr::filter(duplicated(helper2) == FALSE) %>% 
  select(helper2, team, predicted_votes, sd_votes, top_1_chance, top_2_chance, top_3_chance, top_5_chance, top_10_chance,top_20_chance, team_top_chance)


# ----------------------------------------------------------------
# FIRST 5 ROUNDS

first_5_rounds <- predictions1 %>%
  ungroup() %>%
  dplyr::filter(round <= 5 ) %>%
  select(c(.draw, prediction, round, match_id, helper, player, team, round, dfs_score, disposals, goals, score_involvements, winning_team, coach_votes)) %>%
  mutate(helper2 = paste0(player, team)) %>%
  dplyr::group_by(.draw, helper2,) %>%
  mutate(total_votes_per_draw = sum(prediction)) %>%
  dplyr::filter(duplicated(.draw) == FALSE) %>%
  dplyr::group_by(.draw) %>%
  mutate(is_top_1   = ifelse(rank(desc(total_votes_per_draw)/10) <2, 1, 0),
         is_top_2   = ifelse(rank(desc(total_votes_per_draw)/10) <3, 1, 0),
         is_top_3   = ifelse(rank(desc(total_votes_per_draw)/10) <4, 1, 0),
         is_top_5   = ifelse(rank(desc(total_votes_per_draw)/10) <6, 1, 0),
         is_top_10  = ifelse(rank(desc(total_votes_per_draw)/10) <11, 1, 0),
         is_top_20  = ifelse(rank(desc(total_votes_per_draw)/20) <21, 1, 0)) %>%
  ungroup() %>%
  dplyr::group_by(.draw, team) %>%
  mutate(team_top  = ifelse(rank(desc(total_votes_per_draw)/samples) <2, 1, 0)) %>%
  dplyr::group_by(helper2) %>%
  mutate(predicted_votes   = mean(total_votes_per_draw),
         sd_votes    = round(standard_error(total_votes_per_draw) * 10, 2),
         top_1_chance = sum(is_top_1)/10,
         top_2_chance = sum(is_top_2)/10,
         top_3_chance = sum(is_top_3)/10,
         top_5_chance = sum(is_top_5)/10,
         top_10_chance = sum(is_top_10)/10,
         top_20_chance = sum(is_top_20)/10,
         team_top_chance = sum(team_top)/10)  %>%
  arrange(prediction) %>%
  dplyr::filter(duplicated(helper2) == FALSE) %>% 
  select(helper2, team, predicted_votes, sd_votes, top_1_chance)

first_10_rounds <- predictions1 %>%
  ungroup() %>%
  dplyr::filter(round <=10 ) %>%
  select(c(.draw, prediction, round, match_id, helper, player, team, round, dfs_score, disposals, goals, score_involvements, winning_team, coach_votes)) %>%
  mutate(helper2 = paste0(player, team)) %>%
  dplyr::group_by(.draw, helper2,) %>%
  mutate(total_votes_per_draw = sum(prediction)) %>%
  dplyr::filter(duplicated(.draw) == FALSE) %>%
  dplyr::group_by(.draw) %>%
  mutate(is_top_1   = ifelse(rank(desc(total_votes_per_draw)/10) <2, 1, 0),
         is_top_2   = ifelse(rank(desc(total_votes_per_draw)/10) <3, 1, 0),
         is_top_3   = ifelse(rank(desc(total_votes_per_draw)/10) <4, 1, 0),
         is_top_5   = ifelse(rank(desc(total_votes_per_draw)/10) <6, 1, 0),
         is_top_10  = ifelse(rank(desc(total_votes_per_draw)/10) <11, 1, 0),
         is_top_20  = ifelse(rank(desc(total_votes_per_draw)/20) <21, 1, 0)) %>%
  ungroup() %>%
  dplyr::group_by(.draw, team) %>%
  mutate(team_top  = ifelse(rank(desc(total_votes_per_draw)/samples) <2, 1, 0)) %>%
  dplyr::group_by(helper2) %>%
  mutate(predicted_votes   = mean(total_votes_per_draw),
         sd_votes    = round(standard_error(total_votes_per_draw) * 10, 2),
         top_1_chance = sum(is_top_1)/10,
         top_2_chance = sum(is_top_2)/10,
         top_3_chance = sum(is_top_3)/10,
         top_5_chance = sum(is_top_5)/10,
         top_10_chance = sum(is_top_10)/10,
         top_20_chance = sum(is_top_20)/10,
         team_top_chance = sum(team_top)/10)  %>%
  arrange(prediction) %>%
  dplyr::filter(duplicated(helper2) == FALSE) %>% 
  select(helper2, team, predicted_votes, sd_votes, top_1_chance)



last_8_rounds <- predictions1 %>%
  ungroup() %>%
  dplyr::filter(round >= 16 ) %>%
  select(c(.draw, prediction, round, match_id, helper, player, team, round, dfs_score, disposals, goals, score_involvements, winning_team, coach_votes)) %>%
  mutate(helper2 = paste0(player, team)) %>%
  dplyr::group_by(.draw, helper2,) %>%
  mutate(total_votes_per_draw = sum(prediction)) %>%
  dplyr::filter(duplicated(.draw) == FALSE) %>%
  dplyr::group_by(.draw) %>%
  mutate(is_top_1   = ifelse(rank(desc(total_votes_per_draw)/10) <2, 1, 0),
         is_top_2   = ifelse(rank(desc(total_votes_per_draw)/10) <3, 1, 0),
         is_top_3   = ifelse(rank(desc(total_votes_per_draw)/10) <4, 1, 0),
         is_top_5   = ifelse(rank(desc(total_votes_per_draw)/10) <6, 1, 0),
         is_top_10  = ifelse(rank(desc(total_votes_per_draw)/10) <11, 1, 0),
         is_top_20  = ifelse(rank(desc(total_votes_per_draw)/20) <21, 1, 0)) %>%
  ungroup() %>%
  dplyr::group_by(.draw, team) %>%
  mutate(team_top  = ifelse(rank(desc(total_votes_per_draw)/samples) <2, 1, 0)) %>%
  dplyr::group_by(helper2) %>%
  mutate(predicted_votes   = mean(total_votes_per_draw),
         sd_votes    = round(standard_error(total_votes_per_draw) * 10, 2),
         top_1_chance = sum(is_top_1)/10,
         top_2_chance = sum(is_top_2)/10,
         top_3_chance = sum(is_top_3)/10,
         top_5_chance = sum(is_top_5)/10,
         top_10_chance = sum(is_top_10)/10,
         top_20_chance = sum(is_top_20)/10,
         team_top_chance = sum(team_top)/10)  %>%
  arrange(prediction) %>%
  dplyr::filter(duplicated(helper2) == FALSE) %>% 
  select(helper2, team, predicted_votes, sd_votes, top_1_chance)
  

no_t_miller <- predictions1 %>%
  ungroup() %>%
  select(c(.draw, prediction, match_id, helper, player, team, round, dfs_score, disposals, goals, score_involvements, winning_team, coach_votes)) %>%
  dplyr::filter(player != "Touk Miller") %>%
  mutate(helper2 = paste0(player, team)) %>%
  dplyr::group_by(.draw, helper2,) %>%
  mutate(total_votes_per_draw = sum(prediction)) %>%
  dplyr::filter(duplicated(.draw) == FALSE) %>%
  dplyr::group_by(.draw) %>%
  mutate(is_top_1   = ifelse(rank(desc(total_votes_per_draw)/10) <2, 1, 0),
         is_top_2   = ifelse(rank(desc(total_votes_per_draw)/10) <3, 1, 0),
         is_top_3   = ifelse(rank(desc(total_votes_per_draw)/10) <4, 1, 0),
         is_top_5   = ifelse(rank(desc(total_votes_per_draw)/10) <6, 1, 0),
         is_top_10  = ifelse(rank(desc(total_votes_per_draw)/10) <11, 1, 0),
         is_top_20  = ifelse(rank(desc(total_votes_per_draw)/20) <21, 1, 0)) %>%
  ungroup() %>%
  dplyr::group_by(.draw, team) %>%
  mutate(team_top   = ifelse(rank(desc(total_votes_per_draw)/samples) <2, 1, 0),
         team_votes = sum(total_votes_per_draw)) %>%
  dplyr::group_by(helper2) %>%
  mutate(predicted_votes   = mean(total_votes_per_draw),
         sd_votes    = round(standard_error(total_votes_per_draw) * 10, 2),
         top_1_chance = sum(is_top_1)/10,
         top_2_chance = sum(is_top_2)/10,
         top_3_chance = sum(is_top_3)/10,
         top_5_chance = sum(is_top_5)/10,
         top_10_chance = sum(is_top_10)/10,
         top_20_chance = sum(is_top_20)/10,
         team_top_chance = sum(team_top)/10)  %>%
  dplyr::group_by(team) %>%
  mutate(team_votes_chance =sum(team_votes)/10) %>%
  arrange(prediction) %>%
  dplyr::filter(duplicated(helper2) == FALSE) %>% 
  select(helper2, team, predicted_votes, sd_votes, top_1_chance, top_2_chance, top_3_chance, top_5_chance, top_10_chance,top_20_chance, team_top_chance)



no_t_mitchell <- predictions1 %>%
  ungroup() %>%
  select(c(.draw, prediction, match_id, helper, player, team, round, dfs_score, disposals, goals, score_involvements, winning_team, coach_votes)) %>%
  dplyr::filter(player != "Tom Mitchell") %>%
  mutate(helper2 = paste0(player, team)) %>%
  dplyr::group_by(.draw, helper2,) %>%
  mutate(total_votes_per_draw = sum(prediction)) %>%
  dplyr::filter(duplicated(.draw) == FALSE) %>%
  dplyr::group_by(.draw) %>%
  mutate(is_top_1   = ifelse(rank(desc(total_votes_per_draw)/10) <2, 1, 0),
         is_top_2   = ifelse(rank(desc(total_votes_per_draw)/10) <3, 1, 0),
         is_top_3   = ifelse(rank(desc(total_votes_per_draw)/10) <4, 1, 0),
         is_top_5   = ifelse(rank(desc(total_votes_per_draw)/10) <6, 1, 0),
         is_top_10  = ifelse(rank(desc(total_votes_per_draw)/10) <11, 1, 0),
         is_top_20  = ifelse(rank(desc(total_votes_per_draw)/20) <21, 1, 0)) %>%
  ungroup() %>%
  dplyr::group_by(.draw, team) %>%
  mutate(team_top   = ifelse(rank(desc(total_votes_per_draw)/samples) <2, 1, 0),
         team_votes = sum(total_votes_per_draw)) %>%
  dplyr::group_by(helper2) %>%
  mutate(predicted_votes   = mean(total_votes_per_draw),
         sd_votes    = round(standard_error(total_votes_per_draw) * 10, 2),
         top_1_chance = sum(is_top_1)/10,
         top_2_chance = sum(is_top_2)/10,
         top_3_chance = sum(is_top_3)/10,
         top_5_chance = sum(is_top_5)/10,
         top_10_chance = sum(is_top_10)/10,
         top_20_chance = sum(is_top_20)/10,
         team_top_chance = sum(team_top)/10)  %>%
  dplyr::group_by(team) %>%
  mutate(team_votes_chance =sum(team_votes)/10) %>%
  arrange(prediction) %>%
  dplyr::filter(duplicated(helper2) == FALSE) %>% 
  select(helper2, team, predicted_votes, sd_votes, top_1_chance, top_2_chance, top_3_chance, top_5_chance, top_10_chance,top_20_chance, team_top_chance)






no_j_steele <- predictions1 %>%
  ungroup() %>%
  select(c(.draw, prediction, match_id, helper, player, team, round, dfs_score, disposals, goals, score_involvements, winning_team, coach_votes)) %>%
  dplyr::filter(player != "Marcus Bontempelli" & player != "Jack Macrae") %>%
  mutate(helper2 = paste0(player, team)) %>%
  dplyr::group_by(.draw, helper2,) %>%
  mutate(total_votes_per_draw = sum(prediction)) %>%
  dplyr::filter(duplicated(.draw) == FALSE) %>%
  dplyr::group_by(.draw) %>%
  mutate(is_top_1   = ifelse(rank(desc(total_votes_per_draw)/10) <2, 1, 0),
         is_top_2   = ifelse(rank(desc(total_votes_per_draw)/10) <3, 1, 0),
         is_top_3   = ifelse(rank(desc(total_votes_per_draw)/10) <4, 1, 0),
         is_top_5   = ifelse(rank(desc(total_votes_per_draw)/10) <6, 1, 0),
         is_top_10  = ifelse(rank(desc(total_votes_per_draw)/10) <11, 1, 0),
         is_top_20  = ifelse(rank(desc(total_votes_per_draw)/20) <21, 1, 0)) %>%
  ungroup() %>%
  dplyr::group_by(.draw, team) %>%
  mutate(team_top   = ifelse(rank(desc(total_votes_per_draw)/samples) <2, 1, 0),
         team_votes = sum(total_votes_per_draw)) %>%
  dplyr::group_by(helper2) %>%
  mutate(predicted_votes   = mean(total_votes_per_draw),
         sd_votes    = round(standard_error(total_votes_per_draw) * 10, 2),
         top_1_chance = sum(is_top_1)/10,
         top_2_chance = sum(is_top_2)/10,
         top_3_chance = sum(is_top_3)/10,
         top_5_chance = sum(is_top_5)/10,
         top_10_chance = sum(is_top_10)/10,
         top_20_chance = sum(is_top_20)/10,
         team_top_chance = sum(team_top)/10)  %>%
  dplyr::group_by(team) %>%
  mutate(team_votes_chance =sum(team_votes)/10) %>%
  arrange(prediction) %>%
  dplyr::filter(duplicated(helper2) == FALSE) %>% 
  select(helper2, team, predicted_votes, sd_votes, top_1_chance, top_2_chance, top_3_chance, top_5_chance, top_10_chance,top_20_chance, team_top_chance)



no_s_walsh <- predictions1 %>%
  ungroup() %>%
  select(c(.draw, prediction, match_id, helper, player, team, round, dfs_score, disposals, goals, score_involvements, winning_team, coach_votes)) %>%
  dplyr::filter(player != "Sam Walsh") %>%
  mutate(helper2 = paste0(player, team)) %>%
  dplyr::group_by(.draw, helper2,) %>%
  mutate(total_votes_per_draw = sum(prediction)) %>%
  dplyr::filter(duplicated(.draw) == FALSE) %>%
  dplyr::group_by(.draw) %>%
  mutate(is_top_1   = ifelse(rank(desc(total_votes_per_draw)/10) <2, 1, 0),
         is_top_2   = ifelse(rank(desc(total_votes_per_draw)/10) <3, 1, 0),
         is_top_3   = ifelse(rank(desc(total_votes_per_draw)/10) <4, 1, 0),
         is_top_5   = ifelse(rank(desc(total_votes_per_draw)/10) <6, 1, 0),
         is_top_10  = ifelse(rank(desc(total_votes_per_draw)/10) <11, 1, 0),
         is_top_20  = ifelse(rank(desc(total_votes_per_draw)/20) <21, 1, 0)) %>%
  ungroup() %>%
  dplyr::group_by(.draw, team) %>%
  mutate(team_top   = ifelse(rank(desc(total_votes_per_draw)/samples) <2, 1, 0),
         team_votes = sum(total_votes_per_draw)) %>%
  dplyr::group_by(helper2) %>%
  mutate(predicted_votes   = mean(total_votes_per_draw),
         sd_votes    = round(standard_error(total_votes_per_draw) * 10, 2),
         top_1_chance = sum(is_top_1)/10,
         top_2_chance = sum(is_top_2)/10,
         top_3_chance = sum(is_top_3)/10,
         top_5_chance = sum(is_top_5)/10,
         top_10_chance = sum(is_top_10)/10,
         top_20_chance = sum(is_top_20)/10,
         team_top_chance = sum(team_top)/10)  %>%
  dplyr::group_by(team) %>%
  mutate(team_votes_chance =sum(team_votes)/10) %>%
  arrange(prediction) %>%
  dplyr::filter(duplicated(helper2) == FALSE) %>% 
  select(helper2, team, predicted_votes, sd_votes, top_1_chance, top_2_chance, top_3_chance, top_5_chance, top_10_chance,top_20_chance, team_top_chance)

  #        player_share_per_draw = prediction/total_votes) %>%
  # group_by(helper, .draw) %>%
  # mutate(standard_prediction = prediction*standard_to_6,
  #        vote_share = sum(standard_prediction) / samples) %>%
  # arrange(prediction) %>%
  # filter(duplicated(helper) == FALSE)
  # 
  # 
  
  # Calculate total season votes
season_predictions <- predictions2 %>%
  mutate(helper2 = paste0(player, team)) %>%
  group_by(player) %>%
  mutate(season_total = sum(avg_votes)) %>%
  arrange(season_total) %>%
  filter(duplicated(player) == FALSE) %>%
  select(player, team, season_total)
  

```

```{r Save to csv}

write.csv(prediction3,       "brownlow_model_2021.csv")
write.csv(first_5_rounds,    "first_5_rounds.csv")
write.csv(first_10_rounds,   "first_10_rounds.csv")
write.csv(last_8_rounds,     "last_8_rounds.csv")

```


######## NOTES
# add umpires variables
# add if captain?
# add distinct apperarance
# add coach votes/bests
# add overall margin
# add quarter by quarter margin


# IDEAS / TO DO
#  make umpires-brownlow dummy variable, run correaltion with each individal umpire and variables (also do umpire group and variables)
#

NOTES
# Cumulative model: can have negative values and cant use category-specific events (where predictors have different effects in each category)
# - category specific = use cs()
# - logistic = logistic distribution
# - probit  = normal distribution
